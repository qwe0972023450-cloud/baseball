(function(){
const KEY='bt_v2_save';const $=id=>document.getElementById(id);const now=()=>new Date().toISOString();const rid=()=>Math.random().toString(36).slice(2,10);
const TEAMS=[{id:'mlb-nyy',name:'Yankees'},{id:'mlb-lad',name:'Dodgers'},{id:'npb-han',name:'Hanshin Tigers'},{id:'kbo-ktw',name:'KT Wiz'},{id:'cpbl-ctbc',name:'CTBC Brothers'}];
const POS=['SP','RP','C','1B','2B','SS','3B','LF','CF','RF','DH'];const NAMES=['Lin','Chen','Wang','Liu','Huang','Suzuki','Tanaka','Sato','Kim','Park','Lee','Smith','Perez','Garcia','Brown'];
function genPlayers(){const arr=[];for(const t of TEAMS){for(let i=0;i<14;i++){arr.push({pid:rid(),name:NAMES[Math.floor(Math.random()*NAMES.length)]+' '+String.fromCharCode(65+Math.floor(Math.random()*26)),team:t.id,age:18+Math.floor(Math.random()*15),pos:POS[Math.floor(Math.random()*POS.length)],ovr:48+Math.floor(Math.random()*45),pot:60+Math.floor(Math.random()*35),health:100,injured:false,injury_days:0,contract:{team:t.id,salary:40000+Math.floor(Math.random()*180000),years:1+Math.floor(Math.random()*3),days_left:365}});} }return arr;}
let S=null;function save(){localStorage.setItem(KEY,JSON.stringify(S));renderAll();}function load(){const s=localStorage.getItem(KEY);if(!s)return null;S=JSON.parse(s);return S;}
function newSave(mode,nick,team){S={meta:{id:'save-'+Date.now(),created:now(),mode,nick,team,version:'v2'},assets:{cash:600000,fans:180,prestige:0,stadium:{cap:12000,level:1},ticket:20},players:genPlayers(),offers:[],trades:[],fixtures:[],league:{},leaderboard:[],match:{inning:1,half:'top',outs:0,bases:[0,0,0],score:{home:0,away:0},log:[]}};save();}
function side(){return S.match.half==='top'?'客隊':'主隊';}
function push(m){S.match.log.push(m);if(S.match.log.length>200)S.match.log.shift();}
function outcome(){const r=Math.random();if(r<0.06)return['HR','全壘打'];if(r<0.18)return['H','安打'];if(r<0.22)return['BB','保送'];if(r<0.25)return['HBP','觸身'];if(r<0.60)return['OUT','出局'];return['K','三振'];}
function adv(b,n){let runs=0;for(let i=0;i<n;i++){if(b[2]==1)runs++;b[2]=b[1];b[1]=b[0];b[0]=1;}return runs;}
function apply(o){const st=S.match,b=st.bases;if(o==='HR'){const r=1+b[0]+b[1]+b[2];st.bases=[0,0,0];const k=st.half==='bot'?'home':'away';st.score[k]+=r;push(`${side()} 轟出全壘打，${r}分！`);}else if(o==='H'){const r=adv(b,1);const k=st.half==='bot'?'home':'away';st.score[k]+=r;push(`${side()} 安打${r?('，得'+r+'分'):''}`);}else if(o==='BB'||o==='HBP'){if(b[0]&&b[1]&&b[2]){const k=st.half==='bot'?'home':'away';st.score[k]+=1;push(`${side()} 擠回一分！`);}else{if(b[0]&&b[1]&&!b[2])b[2]=1;else if(b[0]&&!b[1])b[1]=1;else if(!b[0])b[0]=1;push(`${side()} 上壘。`);}}else{st.outs++;push(`${side()} 出局，目前 ${st.outs} 出。`);if(st.outs>=3){st.outs=0;st.bases=[0,0,0];if(st.half==='top')st.half='bot';else{st.half='top';st.inning++;}push(`半局結束，進入第 ${st.inning} 局${st.half==='top'?'上':'下'}。`);}} save();}
function renderAll(){renderInfo();renderFeed();renderPlayers('');renderRoster();renderOffers();renderOwner();renderLeagueFixtures();renderLB();}
function renderInfo(){if(!S){$('saveinfo').textContent='未建立存檔';return}$('saveinfo').textContent=`${S.meta.nick} • 模式:${S.meta.mode} • 現金:$${S.assets.cash}`;$('cash').textContent=S.assets.cash;$('fans').textContent=S.assets.fans;$('prestige').textContent=S.assets.prestige;}
function renderFeed(){if(!S){$('feed').innerHTML='';return}$('feed').innerHTML=S.match.log.slice(-60).map(l=>`<p>${l}</p>`).join('');}
function renderPlayers(q){if(!S)return;q=(q||'').toLowerCase();$('playersTable').querySelector('tbody').innerHTML=S.players.filter(p=>p.name.toLowerCase().includes(q)).slice(0,200).map(p=>`<tr><td>${p.name}</td><td>${p.pos}</td><td>${p.ovr}</td><td>$${p.contract.salary}/y × ${p.contract.years}</td><td><button onclick="window.fillOffer('${p.pid}')">發約</button></td></tr>`).join('');}
function renderOffers(){if(!S){$('offersBox').innerHTML='';return}$('offersBox').innerHTML=S.offers.map(o=>`<div>#${o.offer_id} → ${o.to_player} $${o.salary}/y × ${o.years} <button onclick="window.acceptOffer('${o.offer_id}')">接受</button> <button onclick="window.rejectOffer('${o.offer_id}')">駁回</button></div>`).join('')||'（無報價）';}
function renderRoster(){if(!S)return;$('rosterTable').querySelector('tbody').innerHTML=S.players.slice(0,40).map(p=>`<tr><td>${p.pid}</td><td>${p.name}</td><td>${p.age}</td><td>${p.ovr}</td><td>${p.pot}</td></tr>`).join('');}
function renderOwner(){if(!S)return;$('cash').textContent=S.assets.cash;$('fans').textContent=S.assets.fans;$('prestige').textContent=S.assets.prestige;}
function renderLeagueFixtures(){if(!S)return;$('fixturesBox').textContent=S.fixtures?.length?`賽程 ${S.fixtures.length} 場`:'尚未產生';}
function renderLB(){$('localLeaderboard').innerHTML=(S?.leaderboard?.length?S.leaderboard.slice(0,12).map((r,i)=>`<div>${i+1}. ${r.team} (${r.season})</div>`).join(''):'無');}
function expectedSalary(p){const base=p.ovr*2000+p.pot*1000;const ageAdj=Math.max(0,(28-p.age)*500);return Math.max(20000,Math.floor(base/10+ageAdj));}
function accChance(p,salary,years){const exp=expectedSalary(p);const ratio=salary/exp;let c=0.2+(ratio-1)*0.6+(p.pot-60)/100*0.2;c+=Math.random()*0.1;return Math.max(0.05,Math.min(0.98,c));}
function offer(toPid,sal,yrs){const p=S.players.find(x=>x.pid===toPid);if(!p)return alert('找不到球員');const o={offer_id:rid(),from:S.meta.id,to_player:toPid,salary:Number(sal),years:Number(yrs),created:now()};S.offers.push(o);save();}
function accept(id){const i=S.offers.findIndex(o=>o.offer_id===id);if(i<0)return;const o=S.offers[i];const p=S.players.find(x=>x.pid===o.to_player);const chance=accChance(p,o.salary,o.years);if(Math.random()<chance){p.team=S.meta.id;p.contract={team:S.meta.id,salary:o.salary,years:o.years,days_left:o.years*365};push(`✅ ${p.name} 接受報價`);}else{push(`❌ ${p.name} 拒絕報價`);}S.offers.splice(i,1);save();}
function reject(id){const i=S.offers.findIndex(o=>o.offer_id===id);if(i>=0)S.offers.splice(i,1);save();}
function trade(outPid,inPid){const A=S.players.find(p=>p.pid===outPid),B=S.players.find(p=>p.pid===inPid);if(!A||!B)return'找不到球員';const val=x=>x.ovr*3+x.pot*2-(x.age-27)*1.2;const delta=val(A)-val(B);const ok=(delta>-10&&delta<15)||Math.random()<0.1;if(ok){const tA=A.team;A.team=B.team;B.team=tA;push(`🔁 交易成功：${A.name} ↔ ${B.name}`);save();return'交易成功';}push('交易被拒絕');return'被拒絕';}
function train(pid,hrs){const p=S.players.find(x=>x.pid===pid);if(!p)return{ok:false};const base=0.15*hrs;const ageP=Math.max(0,(p.age-25)*0.02*hrs);const d=Math.max(0,Math.floor((base-ageP)*10*(p.pot/90)));p.ovr=Math.min(99,p.ovr+d);if(Math.random()<0.05)p.pot=Math.min(99,p.pot+1);if(Math.random()<0.04){p.injured=true;p.injury_days=7+Math.floor(Math.random()*21);push(`⚕️ ${p.name} 受傷，休養 ${p.injury_days} 天`);}save();return{ok:true,delta:d,player:p};}
function setTicket(price,cap){S.assets.ticket=Number(price);S.assets.stadium.cap=Number(cap);save();}
function sponsor(){const tier=[50000,100000,250000,500000][Math.floor(Math.random()*4)];const gain=Math.floor(tier*(0.8+Math.random()*0.8));S.assets.cash+=gain;S.assets.prestige+=Math.floor(gain/120000);push('贊助 +$'+gain);save();}
function pay(){const payroll=S.players.filter(p=>p.contract?.team===S.meta.id).reduce((a,p)=>a+(p.contract.salary/12),0);S.assets.cash-=Math.floor(payroll);push('支付薪資 -$'+Math.floor(payroll));save();}
function gen(ids,season){const t=ids.slice();if(t.length%2===1)t.push('BYE');const n=t.length,r=n-1;let arr=t.slice();const fix=[];let day=1;for(let k=0;k<r;k++){for(let i=0;i<n/2;i++){const a=arr[i],b=arr[n-1-i];if(a!=='BYE'&&b!=='BYE')fix.push({fid:rid(),day,home:a,away:b,season});day++;}arr=[arr[0]].concat([arr[arr.length-1]]).concat(arr.slice(1,arr.length-1));}S.fixtures=fix;save();return fix;}
function g(){return{home:Math.floor(Math.random()*6),away:Math.floor(Math.random()*6)};}
function runSeason(){if(!S.fixtures?.length)return alert('先產生賽程');const tbl={};const touch=id=>tbl[id]||(tbl[id]={id,pts:0,w:0,l:0,gd:0});for(const f of S.fixtures){touch(f.home);touch(f.away);const s=g();if(s.home>s.away){tbl[f.home].w++;tbl[f.home].pts+=2;tbl[f.away].l++;}else if(s.away>s.home){tbl[f.away].w++;tbl[f.away].pts+=2;tbl[f.home].l++;}else{tbl[f.home].pts++;tbl[f.away].pts++;}tbl[f.home].gd+=s.home-s.away;tbl[f.away].gd+=s.away-s.home;}const table=Object.values(tbl).sort((a,b)=>b.pts-a.pts||b.gd-a.gd);S.league.table=table;save();$('leagueTable').innerHTML='<ol>'+table.map(t=>`<li>${t.id} • ${t.pts} pts (W:${t.w} L:${t.l})</li>`).join('')+'</ol>';if(table.length){S.leaderboard.unshift({team:table[0].id,season:new Date().getFullYear(),date:now()});if(S.leaderboard.length>50)S.leaderboard.pop();}}
function playoffs(){const table=S.league.table||[];if(table.length<4)return alert('需要至少 4 隊');const top4=table.slice(0,4).map(t=>t.id);function series(a,b){let A=0,B=0;while(A<4&&B<4){const s=g();if(s.home>=s.away)A++;else B++;}return A>B?a:b;}const s1=series(top4[0],top4[3]),s2=series(top4[1],top4[2]);const champ=series(s1,s2);push('🏆 冠軍：'+champ);save();}
async function pushGist(token){const url='https://api.github.com/gists';const body={public:false,description:'BT v2 leaderboard',files:{'leaderboard.json':{content:JSON.stringify(S.leaderboard,null,2)}}};const r=await fetch(url,{method:'POST',headers:{'Authorization':'token '+token,'Content-Type':'application/json'},body:JSON.stringify(body)});alert(r.ok?'已上傳':'上傳失敗');}
async function pullGist(token){const r=await fetch('https://api.github.com/gists',{headers:{'Authorization':'token '+token}});if(!r.ok)return alert('取得失敗');const arr=await r.json();for(const g of arr){if(g.files&&g.files['leaderboard.json']){try{S.leaderboard=JSON.parse(g.files['leaderboard.json'].content);save();alert('下載完成');return;}catch(e){}}}alert('找不到 leaderboard.json');}
window.addEventListener('load',()=>{
  document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{document.querySelectorAll('.panel').forEach(p=>p.style.display='none');document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));t.classList.add('active');document.getElementById(t.dataset.tab).style.display='flex';}));
  $('start').addEventListener('click',()=>{const n=$('nickname').value||'Player';const m=$('mode').value;const tm=$('team').value||'';newSave(m,n,tm);});
  $('load').addEventListener('click',()=>{load()||alert('無存檔');renderAll();});
  $('pitch').addEventListener('click',()=>{if(!S)return alert('先建立存檔');const [o,t]=outcome();apply(o);});
  $('autoPlay').addEventListener('click',()=>{if(!S)return;if(window._auto){clearInterval(window._auto);window._auto=null;$('autoPlay').textContent='自動';}else{window._auto=setInterval(()=>$('pitch').click(),650);$('autoPlay').textContent='停止';}});
  $('resetMatch').addEventListener('click',()=>{if(!S)return;S.match={inning:1,half:'top',outs:0,bases:[0,0,0],score:{home:0,away:0},log:[]};save();});
  $('searchBtn').addEventListener('click',()=>renderPlayers($('searchName').value));$('listAll').addEventListener('click',()=>renderPlayers(''));
  window.fillOffer=(pid)=>{ $('offerPid').value=pid; $('offerSal').focus(); };
  $('sendOffer').addEventListener('click',()=>{offer($('offerPid').value,$('offerSal').value,$('offerYears').value);renderOffers();});
  $('refreshOffers').addEventListener('click',()=>renderOffers());
  window.acceptOffer=(id)=>accept(id);window.rejectOffer=(id)=>reject(id);
  $('tradeBtn').addEventListener('click',()=>{const r=trade($('tradeOut').value,$('tradeIn').value);$('tradeMsg').textContent=r;});
  $('trainWeek').addEventListener('click',()=>{const r=train($('careerPid').value,Number($('trainHours').value||0));$('careerResult').textContent=r.ok?`+${r.delta} → OVR ${r.player.ovr}`:'失敗';});
  $('viewStats').addEventListener('click',()=>{const p=S?.players?.find(x=>x.pid===($('careerPid').value));alert(p?JSON.stringify(p,null,2):'找不到');});
  $('setTicket').addEventListener('click',()=>setTicket($('ticketPrice').value,$('stadiumCap').value));
  $('sellSponsor').addEventListener('click',()=>sponsor());
  $('paySalaries').addEventListener('click',()=>pay());
  $('genSchedule').addEventListener('click',()=>{const ids=$('leagueTeams').value.split(',').map(s=>s.trim()).filter(Boolean);gen(ids,Number($('leagueSeason').value||2025));renderLeagueFixtures();});
  $('runSeason').addEventListener('click',()=>runSeason());
  $('playoffs').addEventListener('click',()=>playoffs());
  $('pushGist').addEventListener('click',()=>{const t=$('gistToken').value.trim();if(!t)return alert('請輸入 token');pushGist(t);});
  $('pullGist').addEventListener('click',()=>{const t=$('gistToken').value.trim();if(!t)return alert('請輸入 token');pullGist(t);});
  if(!load()){/*no save*/}renderAll();
});})();