(function(){
const STORAGE_KEY='bt_v4_save';
const $=id=>document.getElementById(id);
const rid=()=>Math.random().toString(36).slice(2,10);
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const TEAMS={
  'mlb-nyy':{name:'Yankees',logo:'/static/assets/logo_nyy.svg',color:'#1e3a8a'},
  'mlb-lad':{name:'Dodgers',logo:'/static/assets/logo_lad.svg',color:'#1d4ed8'},
  'npb-han':{name:'Hanshin Tigers',logo:'/static/assets/logo_han.svg',color:'#047857'},
  'kbo-ktw':{name:'KT Wiz',logo:'/static/assets/logo_ktw.svg',color:'#dc2626'},
  'cpbl-ctbc':{name:'CTBC Brothers',logo:'/static/assets/logo_ctbc.svg',color:'#0ea5e9'}
};
const NAMES=['Lin','Chen','Wang','Liu','Huang','Suzuki','Tanaka','Sato','Kim','Park','Lee','Smith','Perez','Garcia','Brown','Johnson','Lopez','Martinez','Davis','Clark'];
function rname(){return NAMES[Math.floor(Math.random()*NAMES.length)]+' '+String.fromCharCode(65+Math.floor(Math.random()*26));}
function makeBatter(t){const contact=45+Math.floor(Math.random()*45),power=35+Math.floor(Math.random()*55),disc=35+Math.floor(Math.random()*55),speed=35+Math.floor(Math.random()*55),ovr=Math.floor(contact*.35+power*.35+disc*.15+speed*.15);return{pid:rid(),name:rname(),team:t,contact,power,disc,speed,ovr,bstats:{AB:0,H:0,R:0,RBI:0,BB:0,K:0,HR:0}};}
function makePitcher(t,role){const stuff=45+Math.floor(Math.random()*45),control=35+Math.floor(Math.random()*55),stamina=role==='SP'?(70+Math.floor(Math.random()*25)):(45+Math.floor(Math.random()*35)),ovr=Math.floor(stuff*.5+control*.3+stamina*.2);const mix=[{type:'FF',q:40+Math.floor(Math.random()*41)},{type:'SL',q:40+Math.floor(Math.random()*41)},{type:'CH',q:40+Math.floor(Math.random()*41)},{type:'CB',q:40+Math.floor(Math.random()*41)},{type:'SI',q:40+Math.floor(Math.random()*41)}];return{pid:rid(),name:rname(),team:t,role,stuff,control,stamina,ovr,mix,pstats:{OUTS:0,H:0,R:0,BB:0,K:0,HR:0},fatigue:0};}
function genTeam(id){const info=TEAMS[id];const lineup=[];for(let i=0;i<9;i++) lineup.push(makeBatter(id));const sp=makePitcher(id,'SP');const pen=[makePitcher(id,'RP'),makePitcher(id,'RP'),makePitcher(id,'RP')];return{id,name:info.name,logo:info.logo,color:info.color,lineup,order:0,sp,pen,curPitcher:sp,stats:{R:0,H:0,E:0,LOB:0}};}
let S=null;
function newGame(nick,awayId,homeId){const away=genTeam(awayId),home=genTeam(homeId);S={meta:{id:'save-'+Date.now(),nick,version:'v4'},away,home,game:{inning:1,half:'top',outs:0,balls:0,strikes:0,bases:[0,0,0],score:{away:0,home:0},innings:{away:[],home:[]},log:[],finished:false,leadForGood:null,lastPitcher:{away:away.curPitcher,home:home.curPitcher},final:{wp:null,lp:null,sv:null}}};persist();renderAll();banner('æ¯”è³½é–‹å§‹ï¼š'+away.name+' @ '+home.name);}
function persist(){localStorage.setItem(STORAGE_KEY,JSON.stringify(S));}
function load(){const s=localStorage.getItem(STORAGE_KEY);if(!s)return null;S=JSON.parse(s);return S;}
function banner(msg){const el=$('statusBar');if(el){el.textContent=msg;el.style.background='linear-gradient(90deg,#1b9bd6,#1b6fb2)';}}
function pushLog(msg){S.game.log.push(msg);const f=$('feed');if(f){const p=document.createElement('p');p.textContent=msg;f.appendChild(p);f.scrollTop=f.scrollHeight;}}
function renderAll(){ $('nameAway').textContent=S.away.name;$('nameHome').textContent=S.home.name;$('logoAway').src=S.away.logo;$('logoHome').src=S.home.logo;$('scoreAway').textContent=S.game.score.away;$('scoreHome').textContent=S.game.score.home;$('inningHalf').textContent=`${S.game.inning} ${S.game.half==='top'?'ä¸Š':'ä¸‹'}`;[$('b1'),$('b2'),$('b3')].forEach((d,i)=>d.classList.toggle('on',S.game.balls>i));[$('s1'),$('s2')].forEach((d,i)=>d.classList.toggle('on',S.game.strikes>i));[$('o1'),$('o2')].forEach((d,i)=>d.classList.toggle('on',S.game.outs>i));$('b1').classList.toggle('on',S.game.bases[0]==1);$('b2').classList.toggle('on',S.game.bases[1]==1);$('b3').classList.toggle('on',S.game.bases[2]==1);$('inningRunAway').textContent=(S.game.innings.away.join(' '));$('inningRunHome').textContent=(S.game.innings.home.join(' '));$('kNick').textContent=S.meta.nick||'-';$('kInning').textContent=`${S.game.inning} ${S.game.half==='top'?'ä¸Š':'ä¸‹'}`;$('kRHE').textContent=`${S.away.stats.R}/${S.away.stats.H}/${S.away.stats.E}  vs  ${S.home.stats.R}/${S.home.stats.H}/${S.home.stats.E}`;$('kLOB').textContent=`${S.away.stats.LOB} vs ${S.home.stats.LOB}`;fillBox('boxAway',S.away.lineup);$('boxAwayName').textContent=S.away.name;fillBox('boxHome',S.home.lineup);$('boxHomeName').textContent=S.home.name;const bat=curBatter(),pit=curPitcher();$('matchup').textContent=`${pit.name}ï¼ˆStuff ${pit.stuff} / Ctrl ${pit.control} / Fatigue ${pit.fatigue}ï¼‰ vs ${bat.name}ï¼ˆC${bat.contact}/P${bat.power}/D${bat.disc}/S${bat.speed}ï¼‰ã€€çƒæ•¸ ${S.game.balls}-${S.game.strikes}`;}
function fillBox(id,lineup){const tb=$(id).querySelector('tbody');tb.innerHTML=lineup.map(b=>`<tr><td>${b.name}</td><td>${b.bstats.AB}</td><td>${b.bstats.H}</td><td>${b.bstats.R}</td><td>${b.bstats.RBI}</td><td>${b.bstats.BB}</td><td>${b.bstats.K}</td><td>${b.bstats.HR}</td></tr>`).join('');}
function curBatSide(){return S.game.half==='top'?'away':'home'}function curPitSide(){return S.game.half==='top'?'home':'away'}function curBatTeam(){return S[curBatSide()]}function curPitTeam(){return S[curPitSide()]}function curBatter(){const t=curBatTeam();return t.lineup[t.order%9]}function curPitcher(){return curPitTeam().curPitcher}
function resetCount(){S.game.balls=0;S.game.strikes=0}function nextBatter(){curBatTeam().order=(curBatTeam().order+1)%9}
function recordInningRuns(){const k=curBatSide();const arr=S.game.innings[k];const total=S.game.score[k];const prev=arr.reduce((a,b)=>a+b,0);arr.push(total-prev);}
function endHalfInning(){const lob=S.game.bases[0]+S.game.bases[1]+S.game.bases[2];S[curBatSide()].stats.LOB+=lob;recordInningRuns();S.game.outs=0;S.game.bases=[0,0,0];resetCount();if(S.game.half==='top'){S.game.half='bot'}else{S.game.half='top';S.game.inning++}banner(`åŠå±€çµæŸï¼š${S.away.name} ${S.game.score.away} - ${S.home.name} ${S.game.score.home}`);}
function maybeFinish(){if(S.game.inning>12){return finalize('12å±€å¾Œè£å®š')}if(S.game.inning>=9){if(S.game.half==='bot'){if(S.game.score.home!==S.game.score.away){return finalize('ä¹å±€çµæŸ')}}}}
function scoreRun(n){const k=curBatSide(),opp=curPitSide();const before=S.game.score[k]-S.game.score[opp];S.game.score[k]+=n;S[k].stats.R=S.game.score[k];const after=S.game.score[k]-S.game.score[opp];if(before<=0&&after>0){S.game.leadForGood={team:k,wp:S.game.lastPitcher[k]?.name||null,lp:curPitcher().name};}}
function advance(n){const b=S.game.bases;let runs=0;for(let i=0;i<n;i++){if(b[2]){scoreRun(1);b[2]=0;runs++;}if(b[1]){b[2]=1;b[1]=0;}if(b[0]){b[1]=1;b[0]=0;}}return runs;}
function walk(){const b=S.game.bases;if(b[0]&&b[1]&&b[2]){scoreRun(1)}if(b[0]&&b[1]&&!b[2]) b[2]=1;if(b[0]&&!b[1]) b[1]=1;b[0]=1;}
function doPlay(){if(!S)return alert('å…ˆé–‹å§‹æ–°æ¯”è³½');if(S.game.finished)return alert('æœ¬å ´å·²çµæŸ');const off=$('offTactic').value,pType=$('pitchType').value;const bat=curBatter(),pit=curPitcher();const fatigue=pit.fatigue||0;const effStuff=pit.stuff-Math.floor(fatigue/12);const effCtrl=pit.control-Math.floor(fatigue/10);if(off==='steal'&&(S.game.bases[0]||S.game.bases[1])){if(Math.random()<clamp((bat.speed-50)/100+0.55-(effCtrl-55)/120,0.25,0.85)){ if(S.game.bases[0]&&!S.game.bases[1]){S.game.bases[0]=0;S.game.bases[1]=1;pushLog('âš¡ æˆåŠŸç›œå£˜ï¼');} else if(S.game.bases[1]&&!S.game.bases[2]){S.game.bases[2]=1;pushLog('âš¡ æˆåŠŸç›œå£˜ï¼');}}else{if(S.game.bases[1])S.game.bases[1]=0;else if(S.game.bases[0])S.game.bases[0]=0;S.game.outs++;pushLog('ğŸ”’ ç›œå£˜å¤±æ•—ï¼Œè¢«é˜»æ®ºï¼');if(S.game.outs>=3){endHalfInning();renderAll();return;}}}
if(off==='ibb'){walk();bat.bstats.BB++;pit.pstats.BB++;pushLog('âš ï¸ æ•…æ„å››å£ï¼Œä¿é€ä¸Šå£˜ã€‚');nextBatter();renderAll();return;}
if(off==='bunt'&&S.game.outs<2&&(S.game.bases[0]||S.game.bases[1])){if(Math.random()<0.72){const moved=advance(1);S.game.outs++;pushLog(`âš¾ çŠ§ç‰²çŸ­æ‰“æˆåŠŸï¼Œæ¨é€²${moved?'ï¼Œå¾—åˆ† '+moved:''}`);nextBatter();maybeFinish();renderAll();return;}else{S.game.strikes=Math.min(2,S.game.strikes+1);pushLog('çŸ­æ‰“å¤±æ•—ï¼Œç•Œå¤–çƒã€‚');renderAll();return;}}
let pBall=.33-(effCtrl-60)/400+(bat.disc-60)/300,pStrike=.27+(effCtrl-60)/400-(bat.disc-60)/300,pFoul=.12+(bat.contact-60)/400,pInPlay=1-(pBall+pStrike+pFoul);const q=(pit.mix.find(x=>x.type===pType)?.q||60);pStrike+=(q-60)/300;pInPlay+=(effStuff-60)/500-(q-60)/600;pBall=clamp(pBall,0.05,0.6);pStrike=clamp(pStrike,0.1,0.6);pFoul=clamp(pFoul,0.05,0.4);pInPlay=clamp(pInPlay,0.05,0.6);if(off==='swing'){pInPlay+=0.05;pBall-=0.05;}const r=Math.random();if(r<pBall){S.game.balls++;pushLog('å£çƒï¼');if(S.game.balls>=4){pushLog('å››å£çƒï¼Œä¿é€ã€‚');walk();bat.bstats.BB++;pit.pstats.BB++;nextBatter();resetCount();}}else if(r<pBall+pStrike){S.game.strikes++;pushLog('å¥½çƒï¼');if(S.game.strikes>=3){pushLog(`${bat.name} ä¸‰æŒ¯å‡ºå±€ã€‚`);bat.bstats.K++;S.game.outs++;resetCount();nextBatter();}}else if(r<pBall+pStrike+pFoul){if(S.game.strikes<2)S.game.strikes++;pushLog('ç•Œå¤–çƒã€‚');}else{const errChance=0.03;const isErr=Math.random()<errChance;if(isErr){pushLog('å¤±èª¤ï¼æ‰“è€…ä¸Šå£˜ã€‚');S[curPitSide()].stats.E++;advance(1);S.game.bases[0]=1;bat.bstats.AB++;nextBatter();}else{const hitP=clamp(0.24+(bat.contact-60)/400+(bat.power-60)/500-(effStuff-60)/600,0.12,0.42),hrP=clamp(0.03+(bat.power-70)/300,0.005,0.12),xbP=clamp(0.08+(bat.power-60)/400,0.02,0.28);const hrRoll=Math.random(),xbRoll=Math.random(),hitRoll=Math.random();if(hitRoll<hitP){if(hrRoll<hrP){const runs=1+S.game.bases[0]+S.game.bases[1]+S.game.bases[2];S.game.bases=[0,0,0];scoreRun(runs);bat.bstats.AB++;bat.bstats.H++;bat.bstats.HR++;bat.bstats.R+=runs;bat.bstats.RBI+=(runs-1);pit.pstats.H++;pit.pstats.HR++;pit.pstats.R+=runs;S[curBatSide()].stats.H++;pushLog(`ğŸ’¥ ${bat.name} å…¨å£˜æ‰“ï¼${runs} åˆ†ï¼`);nextBatter();}else if(xbRoll<xbP){const dbl=(Math.random()<0.85);const moved=advance(dbl?2:3);if(dbl){S.game.bases[1]=1;}else{S.game.bases[2]=1;S.game.bases[1]=0;S.game.bases[0]=0;}bat.bstats.AB++;bat.bstats.H++;bat.bstats.RBI+=moved;pit.pstats.H++;pit.pstats.R+=moved;S[curBatSide()].stats.H++;pushLog(dbl?'äºŒå£˜å®‰æ‰“ï¼':'ä¸‰å£˜å®‰æ‰“ï¼');nextBatter();}else{const moved=advance(1);S.game.bases[0]=1;bat.bstats.AB++;bat.bstats.H++;bat.bstats.RBI+=moved;pit.pstats.H++;pit.pstats.R+=moved;S[curBatSide()].stats.H++;pushLog(`ä¸€å£˜å®‰æ‰“ï¼${moved?'å¾—åˆ† '+moved:''}`);nextBatter();}}else{const gb=Math.random()<0.5;if(gb&&S.game.outs<=1&&S.game.bases[0]){if(Math.random()<0.5){S.game.outs+=2;S.game.bases[0]=0;pushLog('âš ï¸ é›™æ®ºï¼');}else{S.game.outs++;pushLog('æ»¾åœ°å‡ºå±€ã€‚');}}else if(!gb&&S.game.outs<=1&&S.game.bases[2]){scoreRun(1);S.game.outs++;S.game.bases[2]=0;bat.bstats.RBI++;pushLog('çŠ§ç‰²é£›çƒï¼Œå¸¶å› 1 åˆ†ã€‚');}else{S.game.outs++;pushLog('å‡ºå±€ã€‚');}bat.bstats.AB++;nextBatter();}}}resetCount();curPitcher().fatigue+=1;if(S.game.outs>=3){endHalfInning();}maybeFinish();persist();renderAll();}
function swapPitcher(){const t=curPitTeam();const next=t.pen.shift();if(!next){alert('ç‰›æ£šç”¨ç›¡');return}t.pen.push(t.curPitcher);t.curPitcher=next;S.game.lastPitcher[curPitSide()]=next;pushLog(`ğŸ”„ ${t.name} æ›æŠ•ï¼š${next.name}`);persist();renderAll();}
function finalize(reason){S.game.finished=true;const k=curBatSide();if(S.game.innings[k].length<S.game.inning){recordInningRuns();}let winner=S.game.score.home>S.game.score.away?'home':(S.game.score.away>S.game.score.home?'away':null);if(winner&&S.game.leadForGood&&S.game.leadForGood.team===winner){S.game.final.wp=S.game.leadForGood.wp;S.game.final.lp=S.game.leadForGood.lp;}const line=`${S.away.name}  ${S.game.innings.away.join(' ')}  | R/H/E ${S.away.stats.R}/${S.away.stats.H}/${S.away.stats.E}\n${S.home.name}  ${S.game.innings.home.join(' ')}  | R/H/E ${S.home.stats.R}/${S.home.stats.H}/${S.home.stats.E}\nFinal: ${S.away.name} ${S.game.score.away} - ${S.home.name} ${S.game.score.home} ï¼ˆ${reason}ï¼‰`;$('finalLine').textContent=line;$('finalBox').textContent=`WP: ${S.game.final.wp||'-'}  â€¢  LP: ${S.game.final.lp||'-'}  â€¢  SV: ${S.game.final.sv||'-'}`;$('final').style.display='flex';banner('æ¯”è³½å·²çµæŸ');persist();renderAll();}
window.addEventListener('load',()=>{document.querySelectorAll('.nav button').forEach(btn=>btn.addEventListener('click',()=>{document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));btn.classList.add('active');document.querySelectorAll('.content>.card').forEach(sec=>sec.style.display='none');document.getElementById(btn.dataset.tab).style.display='block';}));$('start').addEventListener('click',()=>{const nick=$('nickname').value||'Player';newGame(nick,$('awaySel').value,$('homeSel').value);});$('pitch').addEventListener('click',()=>doPlay());$('autoHalf').addEventListener('click',()=>{let i=0;while(!S.game.finished&&S.game.outs<3&&i++<500)doPlay();});$('autoGame').addEventListener('click',()=>{let i=0;while(!S.game.finished&&i++<6000)doPlay();if(!S.game.finished)finalize('è‡ªå‹•çµ‚å ´');});$('swapPitcher').addEventListener('click',()=>swapPitcher());$('finalize').addEventListener('click',()=>finalize('è£å®š'));$('closeFinal').addEventListener('click',()=>{$('final').style.display='none';});if(load()){renderAll();}});})();