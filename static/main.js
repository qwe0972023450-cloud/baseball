(function(){
const STORAGE_KEY='bt_v3_save';
const $=id=>document.getElementById(id);const now=()=>new Date().toISOString();const rid=()=>Math.random().toString(36).slice(2,10);const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const TEAMS=[{id:'mlb-nyy',name:'Yankees'},{id:'mlb-lad',name:'Dodgers'},{id:'npb-han',name:'Hanshin Tigers'},{id:'kbo-ktw',name:'KT Wiz'},{id:'cpbl-ctbc',name:'CTBC Brothers'}];
const NAMES=['Lin','Chen','Wang','Liu','Huang','Suzuki','Tanaka','Sato','Kim','Park','Lee','Smith','Perez','Garcia','Brown','Johnson','Lopez','Martinez','Davis','Clark'];
function randName(){return NAMES[Math.floor(Math.random()*NAMES.length)]+' '+String.fromCharCode(65+Math.floor(Math.random()*26));}
function makeBatter(team){const contact=40+Math.floor(Math.random()*45),power=30+Math.floor(Math.random()*60),disc=30+Math.floor(Math.random()*60),speed=30+Math.floor(Math.random()*60),ovr=Math.floor(contact*.35+power*.35+disc*.15+speed*.15);return{pid:rid(),name:randName(),team,pos:'',contact,power,disc,speed,ovr,pot:Math.min(99,ovr+10+Math.floor(Math.random()*20)),bstats:{AB:0,H:0,R:0,RBI:0,BB:0,K:0,HR:0}};}
function makePitcher(team,role){const stuff=40+Math.floor(Math.random()*50),control=30+Math.floor(Math.random()*60),stamina=role==='SP'?(70+Math.floor(Math.random()*30)):(40+Math.floor(Math.random()*40)),ovr=Math.floor(stuff*.5+control*.3+stamina*.2);const mix=[{type:'FF',q:40+Math.floor(Math.random()*41)},{type:'SL',q:40+Math.floor(Math.random()*41)},{type:'CH',q:40+Math.floor(Math.random()*41)},{type:'CB',q:40+Math.floor(Math.random()*41)},{type:'SI',q:40+Math.floor(Math.random()*41)}];return{pid:rid(),name:randName(),team,pos:role,stuff,control,stamina,ovr,pot:Math.min(99,ovr+10+Math.floor(Math.random()*20)),mix,pstats:{OUTS:0,H:0,R:0,BB:0,K:0,HR:0}};}
function genTeam(id){const lineup=[];for(let i=0;i<9;i++) lineup.push(makeBatter(id));const sp=makePitcher(id,'SP');const pen=[makePitcher(id,'RP'),makePitcher(id,'RP'),makePitcher(id,'RP')];return{id,name:TEAMS.find(t=>t.id===id)?.name||id,lineup,order:0,sp,pen,curPitcher:sp};}
let S=null;
function newSave(mode,nick,awayId,homeId){const away=genTeam(awayId),home=genTeam(homeId);S={meta:{id:'save-'+Date.now(),created:now(),mode,nick,version:'v3'},away,home,game:initGame(away,home),players:[],offers:[],trades:[],fixtures:[],league:{},leaderboard:[],assets:{cash:700000,fans:220,prestige:0,stadium:{cap:14000,level:1},ticket:25}};persist();}
function initGame(away,home){return{inning:1,half:'top',outs:0,balls:0,strikes:0,bases:[0,0,0],score:{away:0,home:0},innings:{away:[],home:[]},log:[],box:{away:away.lineup.map(b=>({name:b.name,pid:b.pid,AB:0,H:0,R:0,RBI:0,BB:0,K:0,HR:0})),home:home.lineup.map(b=>({name:b.name,pid:b.pid,AB:0,H:0,R:0,RBI:0,BB:0,K:0,HR:0}))},pit:{away:[{name:away.curPitcher.name,pid:away.curPitcher.pid,OUTS:0,H:0,R:0,BB:0,K:0,HR:0}],home:[{name:home.curPitcher.name,pid:home.curPitcher.pid,OUTS:0,H:0,R:0,BB:0,K:0,HR:0}]},finished:false};}
function persist(){localStorage.setItem(STORAGE_KEY,JSON.stringify(S));renderAll();}
function load(){const s=localStorage.getItem(STORAGE_KEY);if(!s)return null;S=JSON.parse(s);return S;}
function curBatTeam(){return S.game.half==='top'?S.away:S.home;}function curPitTeam(){return S.game.half==='top'?S.home:S.away;}
function curBatter(){const t=curBatTeam();return t.lineup[t.order%9];}function curPitcher(){return curPitTeam().curPitcher;}
function pushFeed(m){S.game.log.push(m);const f=$('feed');if(f){const p=document.createElement('p');p.textContent=m;f.appendChild(p);f.scrollTop=f.scrollHeight;}}
function resetCount(){S.game.balls=0;S.game.strikes=0;}
function renderAll(){if(!S){$('saveinfo').textContent='Êú™Âª∫Á´ãÂ≠òÊ™î';return}$('kAwayName').textContent=S.away.name;$('kHomeName').textContent=S.home.name;$('kAwayR').textContent=S.game.score.away;$('kHomeR').textContent=S.game.score.home;$('saveinfo').textContent=`${S.meta.nick||'Player'} ‚Ä¢ ${S.away.name} @ ${S.home.name}`;$('matchup').textContent=`${curPitcher().name} vs ${curBatter().name}„ÄÄÁêÉÊï∏ ${S.game.balls}-${S.game.strikes}`;renderBox();}
function renderBox(){function fill(id,arr){const tb=$(id).querySelector('tbody');tb.innerHTML=arr.map(r=>`<tr><td>${r.name}</td><td>${r.AB}</td><td>${r.H}</td><td>${r.R}</td><td>${r.RBI}</td><td>${r.BB}</td><td>${r.K}</td><td>${r.HR}</td></tr>`).join('');}fill('boxAway',S.game.box.away);fill('boxHome',S.game.box.home);}
function doWalk(){const b=S.game.bases;if(b[0]&&b[1]&&b[2]) scoreRun(1);if(b[0]&&b[1]&&!b[2]) b[2]=1; if(b[0]&&!b[1]) b[1]=1; b[0]=1;}
function scoreRun(n){const k=S.game.half==='top'?'away':'home';S.game.score[k]+=n;}
function advance(n){const b=S.game.bases;let runs=0;for(let i=0;i<n;i++){if(b[2]){scoreRun(1);runs++;b[2]=0;}if(b[1]){b[2]=1;b[1]=0;}if(b[0]){b[1]=1;b[0]=0;}}return runs;}
function afterPA(){resetCount();curBatTeam().order=(curBatTeam().order+1)%9;}
function endHalf(){const k=S.game.half==='top'?'away':'home';const prev=S.game.innings[k].reduce((a,b)=>a+b,0);const cur=S.game.score[k]-prev;S.game.innings[k].push(cur);S.game.outs=0;S.game.bases=[0,0,0];resetCount();if(S.game.half==='top')S.game.half='bot';else{S.game.half='top';S.game.inning++;}pushFeed(`‚Äî ÂçäÂ±ÄÁµêÊùüÔºåÈÄ≤ÂÖ•Á¨¨ ${S.game.inning} Â±Ä${S.game.half==='top'?'‰∏ä':'‰∏ã'}„ÄÇ`);}
function calcOutcome(){const bat=curBatter(),pit=curPitcher(),pType=$('pitchType').value,off=$('offTactic').value;if(off==='ibb'){doWalk();return{type:'BB'};}if(off==='steal'&&(S.game.bases[0]||S.game.bases[1])){if(Math.random()<0.6){if(S.game.bases[0]){S.game.bases[0]=0;S.game.bases[1]=1;}else if(S.game.bases[1]&&!S.game.bases[2]){S.game.bases[2]=1;S.game.bases[1]=1;}pushFeed('‚ö° ÊàêÂäüÁõúÂ£òÔºÅ');}else{if(S.game.bases[1])S.game.bases[1]=0;else if(S.game.bases[0])S.game.bases[0]=0;S.game.outs++;pushFeed('üîí ÁõúÂ£òÂ§±ÊïóÔºÅ');if(S.game.outs>=3){endHalf();}return{type:'STEAL'};}}if(off==='bunt'&&(S.game.outs<2)&&(S.game.bases[0]||S.game.bases[1])){if(Math.random()<0.7){const moved=advance(1);S.game.outs++;pushFeed(`Áü≠ÊâìÊàêÂäüÔºåÊé®ÈÄ≤ÔºåÂæóÂàÜ ${moved}`);afterPA();if(S.game.outs>=3) endHalf();return{type:'SAC'};}else{S.game.strikes=Math.min(2,S.game.strikes+1);pushFeed('Áü≠ÊâìÂ§±ÊïóÔºåÁïåÂ§ñÁêÉ„ÄÇ');return{type:'FOUL'};}}let pBall=.33-(pit.control-60)/400+(bat.disc-60)/300,pStrike=.27+(pit.control-60)/400-(bat.disc-60)/300,pFoul=.12+(bat.contact-60)/400,pInPlay=1-(pBall+pStrike+pFoul);pBall=clamp(pBall,0.05,0.6);pStrike=clamp(pStrike,0.1,0.6);pFoul=clamp(pFoul,0.05,0.4);pInPlay=clamp(pInPlay,0.05,0.6);if(off==='swing'){pInPlay+=0.05;pBall-=0.05;}const r=Math.random();if(r<pBall)return{type:'BALL'};if(r<pBall+pStrike)return{type:'STRIKE'};if(r<pBall+pStrike+pFoul)return{type:'FOUL'};const hitP=clamp(0.23+(bat.contact-60)/400+(bat.power-60)/500-(pit.stuff-60)/600,0.12,0.4);const hrP=clamp(0.03+(bat.power-70)/300,0.005,0.1);const xbP=clamp(0.08+(bat.power-60)/400,0.02,0.25);const h=Math.random();if(h<hitP){const t=Math.random();if(t<hrP)return{type:'HR'};if(Math.random()<xbP)return{type:(Math.random()<0.85?'2B':'3B')};return{type:'1B'};}return{type:'OUT'};}
function pitch(){if(!S)return alert('ÂÖàÈñãÂßãÊØîË≥Ω');if(S.game.finished)return alert('Â∑≤ÁµêÊùü');const o=calcOutcome();const bat=curBatter(),pit=curPitcher();const pk=S.game.half==='top'?'home':'away';const pl=S.game.pit[pk][S.game.pit[pk].length-1];const bk=S.game.half==='top'?'away':'home';const bi=(S.game.half==='top'?S.away.lineup.indexOf(bat):S.home.lineup.indexOf(bat));const bl=S.game.box[bk][bi];if(o.type==='BALL'){S.game.balls++;pushFeed(`${pit.name} ÊäïÂá∫Â£ûÁêÉÔºå${S.game.balls}-${S.game.strikes}`);if(S.game.balls>=4){pushFeed(`‰øùÈÄÅÔºÅ${bat.name} ‰∏äÂ£ò`);doWalk();bl.BB++;pl.BB++;afterPA();}}else if(o.type==='STRIKE'){S.game.strikes++;pushFeed(`${pit.name} Â•ΩÁêÉÔºÅ ${S.game.balls}-${S.game.strikes}`);if(S.game.strikes>=3){pushFeed(`${bat.name} ‰∏âÊåØÂá∫Â±Ä`);bl.K++;S.game.outs++;resetCount();if(S.game.outs>=3) endHalf(); else afterPA();}}else if(o.type==='FOUL'){if(S.game.strikes<2)S.game.strikes++;pushFeed(`${bat.name} ÁïåÂ§ñÁêÉ`);}else if(o.type==='1B'){const r=advance(1);S.game.bases[0]=1;bl.AB++;bl.H++;bl.RBI+=r;pl.H++;pl.R+=r;pushFeed(`‰∏ÄÂ£òÂÆâÊâìÔºÅÂ∏∂Âõû ${r} ÂàÜ`);afterPA();}else if(o.type==='2B'){const r=advance(2);S.game.bases[1]=1;S.game.bases[0]=0;bl.AB++;bl.H++;bl.RBI+=r;pl.H++;pl.R+=r;pushFeed(`‰∫åÂ£òÂÆâÊâìÔºÅ${r?'ÂæóÂàÜ '+r:''}`);afterPA();}else if(o.type==='3B'){const r=advance(3);S.game.bases[2]=1;S.game.bases[1]=0;S.game.bases[0]=0;bl.AB++;bl.H++;bl.RBI+=r;pl.H++;pl.R+=r;pushFeed(`‰∏âÂ£òÂÆâÊâìÔºÅ`);afterPA();}else if(o.type==='HR'){const runs=1+(S.game.bases[0]?1:0)+(S.game.bases[1]?1:0)+(S.game.bases[2]?1:0);S.game.bases=[0,0,0];S.game.score[S.game.half==='top'?'away':'home']+=runs;bl.AB++;bl.H++;bl.HR++;bl.R+=runs;bl.RBI+=(runs-1);pl.H++;pl.HR++;pl.R+=runs;pushFeed(`üí• ${bat.name} ÂÖ®Â£òÊâìÔºÅ${runs} ÂàÜÁÇÆ`);afterPA();}else if(o.type==='OUT'){S.game.outs++;bl.AB++;pushFeed('ÊâìÊàêÂá∫Â±Ä');resetCount();if(S.game.outs>=3) endHalf(); else afterPA();}renderAll();}
function autoHalf(){let i=0;while(S && S.game.outs<3 && i++<400)pitch();}
function autoGame(){let i=0;while(S && !S.game.finished && i++<4000){pitch();if(S.game.inning>12){S.game.finished=true;pushFeed(`üèÅ Final: ${S.away.name} ${S.game.score.away} - ${S.home.name} ${S.game.score.home}`);break;}}}
window.addEventListener('load',()=>{
document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{document.querySelectorAll('.panel').forEach(p=>p.style.display='none');document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));t.classList.add('active');document.getElementById(t.dataset.tab).style.display='flex';}));
$('start').addEventListener('click',()=>{const nick=$('nickname').value||'Player',mode=$('mode').value;newSave(mode,nick,$('awayTeam').value,$('homeTeam').value);});
$('load').addEventListener('click',()=>{load()||alert('ÁÑ°Â≠òÊ™î');renderAll();});
$('pitch').addEventListener('click',()=>pitch());
$('autoHalf').addEventListener('click',()=>autoHalf());
$('autoGame').addEventListener('click',()=>autoGame());
$('resetMatch').addEventListener('click',()=>{if(!S)return;S.game=initGame(S.away,S.home);renderAll();});
$('swapPitcher').addEventListener('click',()=>{const t=curPitTeam();const n=t.pen.shift();if(!n){alert('ÁâõÊ£öÁî®Áõ°');return}t.pen.push(t.curPitcher);t.curPitcher=n;pushFeed(`üîÑ ÊèõÊäïÔºö${n.name}`);});
renderAll();
});})();